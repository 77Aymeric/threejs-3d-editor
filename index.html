<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Constructeur 3D Pro</title>
    <!-- Tailwind CSS (Still kept for utility classes if needed, though most styles are custom now) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=Fira+Code&display=swap"
        rel="stylesheet">
    <!-- Import Map for bare modules -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
                "three/examples/jsm/controls/OrbitControls": "https://unpkg.com/three@0.128.0/examples/jsm/controls/OrbitControls.js",
                "three/examples/jsm/controls/TransformControls": "https://unpkg.com/three@0.128.0/examples/jsm/controls/TransformControls.js"
            }
        }
    </script>
    <!-- Main Style -->
    <link rel="stylesheet" href="./src/styles/main.css">
</head>

<body>

    <!-- TOOLBAR (Floating) -->
    <div id="ui-toolbar" class="panel-glass">
        <!-- History Controls -->
        <div class="text-left-controls">
            <button class="btn btn-secondary" onclick="undo()" title="Annuler">‚Ü©</button>
            <button class="btn btn-secondary" onclick="redo()" title="R√©tablir">‚Ü™</button>
        </div>

        <!-- Add Objects -->
        <!-- Add Objects -->
        <div class="text-left-controls">
            <button class="btn btn-primary px-2" onclick="ajouterAction('cube')" title="Cube">+ Cube</button>
            <button class="btn btn-primary px-2" onclick="ajouterAction('cylindre')" title="Cylindre">+ Cyl</button>
            <button class="btn btn-primary px-2" onclick="ajouterAction('sphere')" title="Sph√®re">+ Sph</button>
            <button class="btn btn-primary px-2" onclick="ajouterAction('triangle')" title="Triangle">+ Tri</button>
        </div>

        <!-- Transformations -->
        <div class="text-left-controls">
            <button class="btn btn-secondary" onclick="setMode('translate')" title="D√©placer (Z)">‚úõ</button>
            <button class="btn btn-secondary" onclick="setMode('rotate')" title="Tourner (R)">‚Üª</button>
            <button class="btn btn-secondary" onclick="setMode('scale')" title="Redimensionner (S)">‚§°</button>
        </div>

        <!-- Camera -->
        <div class="text-left-controls">
            <button class="btn btn-secondary w-24" id="btn-cam" onclick="toggleCamera()">Persp</button>
        </div>

        <!-- View Options (Text removed for space, relying on tooltips/icons check) -->
        <!-- View Options (Compact with Labels) -->
        <div class="flex gap-2 items-center ml-2 border-l border-white/10 pl-2">
            <label class="toggle-container" title="Aimant">
                <span class="text-[10px] font-bold opacity-70 mr-1">AIMANT</span>
                <input type="checkbox" id="snap-toggle" class="toggle-checkbox" onchange="toggleSnap(this.checked)">
                <div class="toggle-switch"></div>
            </label>

            <label class="toggle-container" title="Local / Monde">
                <span class="text-[10px] font-bold opacity-70 mr-1">LOCAL</span>
                <input type="checkbox" id="local-toggle" class="toggle-checkbox" onchange="toggleSpace(this.checked)">
                <div class="toggle-switch"></div>
            </label>

            <label class="toggle-container" title="Couleurs">
                <span class="text-[10px] font-bold opacity-70 mr-1">COL</span>
                <input type="checkbox" id="colors-toggle" class="toggle-checkbox" checked
                    onchange="toggleColors(this.checked)">
                <div class="toggle-switch"></div>
            </label>

            <label class="toggle-container" title="Lignes">
                <span class="text-[10px] font-bold opacity-70 mr-1">LIGNES</span>
                <input type="checkbox" id="lines-toggle" class="toggle-checkbox" checked
                    onchange="toggleWireframes(this.checked)">
                <div class="toggle-switch"></div>
            </label>
        </div>

        <div style="flex-grow:1"></div>

        <!-- Global Actions -->
        <button class="btn btn-danger mr-2 px-3" onclick="toutEffacer()" title="Tout Effacer">üóëÔ∏è</button>
        <button class="btn btn-secondary mr-2" onclick="ouvrirModalImport()" title="Importer">üìÇ</button>
        <button class="btn btn-success" onclick="exporterCode()" title="Exporter">üíæ</button>
    </div>

    <!-- PANEL ARBORESCENCE (GAUCHE - Floating) -->
    <div id="ui-tree-panel" class="panel-glass">
        <div id="tree-toggle-btn" class="tree-toggle" onclick="toggleTreePanel()">‚óÄ</div>

        <script>
            // Simple toggle script for the tree panel since it's UI logic
            function toggleTreePanel() {
                const panel = document.getElementById('ui-tree-panel');
                const btn = document.getElementById('tree-toggle-btn');
                panel.classList.toggle('collapsed');
                if (panel.classList.contains('collapsed')) {
                    btn.innerText = '‚ñ∂';
                } else {
                    btn.innerText = '‚óÄ';
                }
            }
        </script>

        <div id="tree-header">
            <span>OBJETS SC√àNE</span>
            <span id="obj-count" class="bg-indigo-600 px-2 py-0.5 rounded text-xs">0</span>
        </div>
        <div id="tree-list">
            <!-- Tree items injected here by JS -->
        </div>
    </div>

    <!-- PANEL PROPRIETES (DROITE - Floating) -->
    <div id="ui-sidebar" class="panel-glass">
        <h2 class="text-lg font-bold mb-4 border-b border-gray-700 pb-2">Propri√©t√©s</h2>

        <div id="no-selection" class="text-gray-500 italic text-sm text-center mt-10">
            Aucun objet s√©lectionn√©.<br>Cliquez sur un objet pour l'√©diter.
        </div>

        <div id="object-properties" style="display:none;" class="flex flex-col gap-5">
            <div class="bg-indigo-900/40 p-3 rounded border border-indigo-500/50 text-sm flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-indigo-500"></div>
                <span id="selection-count" class="font-bold text-white">1</span> s√©lectionn√©(s)
            </div>

            <div class="control-group" id="group-name">
                <label class="control-label">Nom de l'objet</label>
                <input type="text" id="input-name" onchange="majNom(this.value)">
            </div>

            <div class="flex gap-2">
                <button class="btn btn-secondary flex-1" onclick="dupliquerSelection()">‚ùê Dupliquer</button>
            </div>

            <div class="control-group">
                <label class="control-label mb-2">Position (Globale)</label>
                <div class="coord-row">
                    <span class="coord-label text-red-500">X</span>
                    <input type="number" step="0.5" id="pos-x" onchange="majPositionParInput()">
                </div>
                <div class="coord-row">
                    <span class="coord-label text-green-500">Y</span>
                    <input type="number" step="0.5" id="pos-y" onchange="majPositionParInput()">
                </div>
                <div class="coord-row">
                    <span class="coord-label text-blue-500">Z</span>
                    <input type="number" step="0.5" id="pos-z" onchange="majPositionParInput()">
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Couleur</label>
                <div style="position:relative; height: 36px">
                    <input type="color" id="input-color" oninput="majCouleur(this.value)"
                        style="position: absolute; top:0; left:0; width:100%; height:100%; opacity: 0;">
                    <div id="color-preview"
                        style="width: 100%; height: 100%; background: #fff; border-radius: 4px; pointer-events: none;">
                    </div>
                </div>
                <!-- Little script to update the preview because input color is hidden -->
                <script>
                    const colInput = document.getElementById('input-color');
                    const colPrev = document.getElementById('color-preview');
                    colInput.addEventListener('input', (e) => colPrev.style.background = e.target.value);
                    // Initial update handled by main.js logic ideally, but good to have listener
                </script>
            </div>

            <button class="btn btn-danger w-full mt-auto" onclick="supprimerSelection()">Supprimer</button>
        </div>

        <div style="flex-grow: 1;"></div>
        <!-- Export button removed from here -->
    </div>

    <!-- MODAL IMPORT -->
    <div id="modal-import" class="backdrop-blur-sm">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-2">Importer du Code</h3>
            <p class="text-sm text-gray-400 mb-4">Collez une fonction JS ou un script Three.js.</p>
            <textarea id="import-area" placeholder="// function maVoiture() { ... }"></textarea>
            <div class="flex gap-2 justify-end mt-4">
                <button class="btn btn-secondary" onclick="fermerModalImport()">Annuler</button>
                <button class="btn btn-success" onclick="executerImport()">Importer</button>
            </div>
        </div>
    </div>

    <!-- MODAL EXPORT -->
    <div id="modal-export" class="backdrop-blur-sm" style="display:none;">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-2">Exporter le Code</h3>
            <p class="text-sm text-gray-400 mb-4">Copiez ce code et utilisez-le dans votre projet.</p>
            <textarea id="export-area" readonly></textarea>
            <div class="flex gap-2 justify-end mt-4">
                <button class="btn btn-secondary" onclick="fermerModalExport()">Fermer</button>
                <button class="btn btn-success" onclick="copierExport()">Copier</button>
            </div>
        </div>
    </div>

    <div id="canvas-container"></div>

    <!-- Main Module -->
    <script type="module" src="./src/main.js"></script>
</body>

</html>